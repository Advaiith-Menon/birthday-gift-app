<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Headache-AI Enhanced</title>

  <!-- PWA Meta Setup -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="#FF4D6D" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">

  <!-- Main Styles -->
  <style>/* Basic reset */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
#avatar-container {
  text-align: center;
  margin: 1rem 0;
  height: 80px; /* Prevent layout shifting */
  position: relative;
}

#avatar-container img {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  border-radius: 50%;
}
/* Dark theme colors */
body {
  font-family: 'Segoe UI', sans-serif;
  background-color: #121212;
  color: #ffffff;
  padding: 20px;
}

.app-header {
  font-size: 1.8rem;
  font-weight: bold;
  text-align: center;
  margin-bottom: 20px;
  color: #90caf9;
}

#chat-window {
  background-color: #1e1e1e;
  border-radius: 10px;
  padding: 15px;
  max-width: 800px;
  margin: 0 auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
}

#chat-log {
  height: 400px;
  overflow-y: auto;
  padding: 10px;
  background-color: #262626;
  border-radius: 8px;
  margin-bottom: 15px;
}

.user-msg {
  text-align: right;
  color: #bb86fc;
  margin-bottom: 10px;
}

.bot-msg {
  text-align: left;
  color: #03dac6;
  margin-bottom: 10px;
}

#input-area {
  display: flex;
  gap: 10px;
  align-items: center;
}

#user-input {
  flex-grow: 1;
  background-color: #2c2c2c;
  color: #fff;
  border: none;
  padding: 10px;
  border-radius: 6px;
  resize: none;
  height: 50px;
}

#send-btn {
  background-color: #03dac6;
  color: #000;
  border: none;
  padding: 0 20px;
  font-size: 1.2rem;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}

#send-btn:hover {
  background-color: #00c4b4;
}

.button-bar {
  margin-top: 10px;
  text-align: center;
}

#reset-btn {
  background-color: #bb86fc;
  color: #000;
  border: none;
  padding: 10px 30px;
  font-size: 1rem;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}

#reset-btn:hover {
  background-color: #9f6ff2;
}</style>
</head>
<body>

  <!-- App Header -->
  <div class="app-header">Headache-AI Enhanced</div>

  <!-- Chat Window -->
  <div id="chat-window">
    <div id="avatar-container">
      <img id="avatar-static" src="{{ url_for('static', filename='avatar_idle.jpg') }}" alt="Avatar" width="80" height="80">
      <img id="avatar-a" src="{{ url_for('static', filename='avatar1.jpg') }}" alt="Avatar A" width="80" height="80" style="display: none;">
      <img id="avatar-b" src="{{ url_for('static', filename='avatar2.jpg') }}" alt="Avatar B" width="80" height="80" style="display: none;">
    </div>

    <div id="chat-log"></div>

    <div id="input-area">
      <textarea id="user-input" placeholder="Talk to me..."></textarea>
      <button id="send-btn" onclick="sendMessage()">➤</button>
    </div>
  </div>

  <!-- Script -->
  <script>

document.addEventListener("DOMContentLoaded", () => {
  // Debounce utility
  function debounce(func, delay) {
    let timer;
    return function (...args) {
      clearTimeout(timer);
      timer = setTimeout(() => func.apply(this, args), delay);
    };
  }

  let avatarInterval;

  function startAvatarAnimation() {
    const avatarA = document.getElementById('avatar-a');
    const avatarB = document.getElementById('avatar-b');
    const avatarStatic = document.getElementById('avatar-static');

    avatarStatic.style.display = 'none';
    avatarA.style.display = 'block';
    avatarB.style.display = 'none';

    avatarInterval = setInterval(() => {
      if (avatarA.style.display === 'block') {
        avatarA.style.display = 'none';
        avatarB.style.display = 'block';
      } else {
        avatarA.style.display = 'block';
        avatarB.style.display = 'none';
      }
    }, 400);
  }

  function stopAvatarAnimation() {
    clearInterval(avatarInterval);
    document.getElementById('avatar-a').style.display = 'none';
    document.getElementById('avatar-b').style.display = 'none';
    document.getElementById('avatar-static').style.display = 'block';
  }

  const sendMessage = debounce(async function () {
    const input = document.getElementById('user-input');
    const chatLog = document.getElementById('chat-log');
    const message = input.value.trim();

    if (!message) return;

    chatLog.innerHTML += `<div class="message user-msg">${message}</div>`;
    chatLog.scrollTop = chatLog.scrollHeight;
    input.value = '';
    input.disabled = true;

    startAvatarAnimation();

    try {
      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });

      const data = await res.json();
      const reply = data.reply;

      stopAvatarAnimation();

      if (reply === "__UNLOCK__") {
        chatLog.innerHTML += `<div class="message bot">Yeah, That is true!!!</div>`;
        chatLog.scrollTop = chatLog.scrollHeight;
        setTimeout(() => {
          window.location.href = "/unlock";
        }, 1500);
      } else {
        chatLog.innerHTML += `<div class="message bot">${reply}</div>`;
        chatLog.scrollTop = chatLog.scrollHeight;
      }

    } catch (error) {
      stopAvatarAnimation();
      chatLog.innerHTML += `<div class="message bot error">❌ Oops! I don't remember that!!!</div>`;
      console.error("Chat error:", error);
    }

    input.disabled = false;
    input.focus();
  }, 400);

  // Submit on Enter key
  document.getElementById("user-input").addEventListener("keypress", function (event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  });

  // Hook for button (optional fallback)
  window.sendMessage = sendMessage;
});

</script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('{{ url_for("static", filename="service-worker.js") }}')
          .then(reg => {
            console.log('Service worker registered:', reg.scope);
          })
          .catch(err => {
            console.error('Service worker registration failed:', err);
          });
      });
    }
  </script>
</body>
</html>
